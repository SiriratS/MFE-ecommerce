name: CI/CD Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions for security
permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  # Job 1: Lint - Run ESLint on affected projects
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup environment
        uses: ./.github/actions/setup-node-pnpm
      
      - name: Run lint on affected projects
        run: pnpm nx affected -t lint --parallel=3 --base=origin/${{ github.event.repository.default_branch }}
      
      - name: Add lint summary
        if: always()
        run: |
          echo "### ðŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "Linted affected projects successfully!" >> $GITHUB_STEP_SUMMARY

  # Job 2: Test - Run unit tests on affected projects
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup environment
        uses: ./.github/actions/setup-node-pnpm
      
      - name: Run tests on affected projects
        run: pnpm nx affected -t test --parallel=3 --configuration=ci --coverage --base=origin/${{ github.event.repository.default_branch }}
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7
        if: always()
      
      - name: Add test summary
        if: always()
        run: |
          echo "### âœ… Test Results" >> $GITHUB_STEP_SUMMARY
          echo "All tests passed on affected projects!" >> $GITHUB_STEP_SUMMARY
          if [ -d "coverage" ]; then
            echo "ðŸ“Š Coverage reports generated" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 3: Build - Build affected applications
  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Setup environment
        uses: ./.github/actions/setup-node-pnpm
      
      - name: Build affected applications
        run: pnpm nx affected -t build --parallel=3 --configuration=production --base=origin/${{ github.event.repository.default_branch }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7
        if: success()
      
      - name: Add build summary
        if: always()
        run: |
          echo "### ðŸ—ï¸ Build Results" >> $GITHUB_STEP_SUMMARY
          if [ -d "dist" ]; then
            echo "Build completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "**Artifacts:** $(du -sh dist/ | cut -f1)" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 4: Security Scan - Check for vulnerabilities
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Setup environment
        uses: ./.github/actions/setup-node-pnpm
      
      - name: Run pnpm audit
        id: audit
        run: |
          pnpm audit --audit-level=high --json > audit-results.json || true
          if [ -s audit-results.json ]; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Add security summary
        if: always()
        run: |
          echo "### ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.audit.outputs.vulnerabilities_found }}" == "true" ]; then
            echo "âš ï¸ Vulnerabilities found! Check the logs for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No high/critical vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Fail if vulnerabilities found
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        run: exit 1
